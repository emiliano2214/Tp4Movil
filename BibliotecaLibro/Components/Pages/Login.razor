@page "/"
@using Microsoft.AspNetCore.Components.Web
@using BibliotecaLibro.Servicios
@using BibliotecaLibro.Shared.Models
@inject UsuarioServicio _usuarioServicio
@inject NavigationManager navigationManager

<div class="login-container">
    <div class="login-card">
        <img src="Images/logo.png" alt="logo" class="logo" />

        <div class="login-form">
            <div class="mb-3">
                <label class="form-label">Usuario</label>
                <input @bind="nombreUsuario"
                       @bind:event="oninput"
                       placeholder="Inserte Usuario"
                       class="form-control text-center"
                       @onkeydown="OnKeyDown" />
            </div>

            <div class="mb-3">
                <label class="form-label">Contraseña</label>
                <input @bind="contrasena"
                       @bind:event="oninput"
                       placeholder="Ingrese Contraseña"
                       type="password"
                       class="form-control text-center"
                       @onkeydown="OnKeyDown" />
            </div>

            <button class="btn btn-primary btn-login"
                    @onclick="IniciarSesion"
                    disabled="@iniciandoSesion">
                @if (iniciandoSesion)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Iniciando...</span>
                }
                else
                {
                    <span>Iniciar Sesión</span>
                }
            </button>

            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="alert alert-danger mt-3 text-center">@mensaje</div>
            }

            @if (cargandoUsuarios)
            {
                <div class="alert alert-info mt-3 text-center">Cargando usuarios...</div>
            }

            <div class="form-check form-switch mt-3 text-start">
                <input class="form-check-input" type="checkbox" id="dbg" @bind="mostrarDebug" />
                <label class="form-check-label" for="dbg"><strong>Mostrar usuarios (debug)</strong></label>
            </div>

            @if (mostrarDebug && (usuariosDTO?.Count > 0))
            {
                <div class="mt-2 text-start">
                    @foreach (var u in usuariosDTO!)
                    {
                        <p>@u.IdUsuario - @u.NombreUsuario (@u.Privilegio)</p>
                    }
                </div>
            }
        </div>
    </div>
</div>

<style>
    .login-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .login-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        max-width: 400px;
        width: 100%;
        text-align: center;
    }

    .logo {
        max-width: 200px;
        margin-bottom: 30px;
    }

    .login-form {
        width: 100%;
    }

    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        display: block;
    }

    .form-control {
        border-radius: 10px;
        border: 2px solid #e1e5e9;
        padding: 12px 15px;
        transition: border-color 0.3s ease;
    }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

    .btn-login {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        transition: transform 0.2s ease;
    }

    .btn-login:hover:not(:disabled) {
        transform: translateY(-2px);
    }

    .btn-login:disabled {
        opacity: 0.7;
    }
</style>

@code {
    private string nombreUsuario = string.Empty;
    private string contrasena = string.Empty;
    private string mensaje = string.Empty;

    private List<UsuarioDTO>? usuariosDTO;
    private bool cargandoUsuarios = false;
    private bool iniciandoSesion = false;
    private bool mostrarDebug = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarUsuarios();
    }

    private async Task CargarUsuarios()
    {
        cargandoUsuarios = true;
        mensaje = string.Empty;
        try
        {
            usuariosDTO = await _usuarioServicio.GetUsuariosAsync();
        }
        catch
        {
            mensaje = "Error al cargar los usuarios. Intente nuevamente.";
            usuariosDTO = new(); // vacío
        }
        finally
        {
            cargandoUsuarios = false;
        }
    }

    private async Task IniciarSesion()
    {
        if (iniciandoSesion) return; // evita doble click
        nombreUsuario = nombreUsuario?.Trim() ?? string.Empty;
        contrasena = contrasena ?? string.Empty;

        if (string.IsNullOrWhiteSpace(nombreUsuario) || string.IsNullOrWhiteSpace(contrasena))
        {
            mensaje = "Por favor complete todos los campos.";
            return;
        }

        iniciandoSesion = true;
        mensaje = string.Empty;

        try
        {
            var loginDTO = new LoginDTO
            {
                NombreUsuario = nombreUsuario,
                Contraseña = contrasena
            };

            var usuario = await _usuarioServicio.LoginAsync(loginDTO);

            if (usuario != null)
            {
                // acá podés persistir algo de sesión si lo necesitás
                navigationManager.NavigateTo("/menu", forceLoad: false);
            }
            else
            {
                mensaje = "Usuario o contraseña incorrectos.";
            }
        }
        catch (Exception ex)
        {
            mensaje = "Error al iniciar sesión: " + ex.Message;
        }
        finally
        {
            iniciandoSesion = false;
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !iniciandoSesion)
        {
            await IniciarSesion();
        }
    }
}
